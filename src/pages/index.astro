---
import Footer from "../components/Footer.astro";
import TodoList from "../components/TodoList.astro";
import { getTodos } from "../data/todos";
import Layout from "../layouts/Page.astro";

const { filter } = Astro.locals;

const todos = getTodos(filter);
---

<Layout>
  <main
    class="h-full w-full flex flex-col items-center lg:max-w-5xl mx-auto p-2 lg:p-8"
  >
    <section
      class="relative ring-1 ring-slate-700/20 shadow-sm px-4 lg:px-14 py-8 bg-white rounded-md"
      hx-vals={`{ "filter": "${Astro.locals.filter}" }`}
    >
      <div id="user-btn-wrapper" class="absolute end-2 top-2"></div>
      <header>
        <h1 class="pb-4">Todos</h1>
        <form
          hx-post="/partials/todos"
          hx-target="#todo-list"
          hx-swap="afterbegin"
          _="on htmx:afterOnLoad set #txtTodo.value to ''"
        >
          <div class="relative mb-4">
            <label for="txtTodo" class="leading-7 text-sm text-gray-600"
              >What needs to be done?</label
            >
            <input
              type="text"
              id="txtTodo"
              name="todo"
              placeholder="What needs to be done?"
              class="w-full bg-white rounded border border-gray-300 focus:border-green-500 focus:ring-2 focus:ring-green-200 text-base outline-none text-gray-700 py-1 px-3 leading-8 transition-colors duration-200 ease-in-out"
              autofocus
            />
          </div>
        </form>
      </header>
      <section class="main">
        <!-- TODO: add "toggle all" functionality
        <input type="checkbox" id="toggle-all" class="toggle-all" />
        <label for="toggle-all">Mark all as complete</label>
      -->

        <ul id="todo-list" class="my-6 space-y-3">
          <TodoList {todos} />
        </ul>
      </section>
      <Footer />
    </section>
  </main>
</Layout>

<script>
  import Clerk from "@clerk/clerk-js";

  // document loaded
  document.addEventListener("DOMContentLoaded", async () => {
    document.querySelector<HTMLDivElement>("#user-btn-wrapper")!.innerHTML = `
  <div
    id="user-button"
  ></div>
`;

    // focus on the input
    const userButtonComponent =
      document.querySelector<HTMLDivElement>("#user-button")!;

    const clerkPublishableKey = import.meta.env.PUBLIC_CLERK_PUBLIC_KEY;
    const clerk = new Clerk(clerkPublishableKey);
    await clerk.load();

    const sessionId = clerk.user?.id;

    if (sessionId) {
      clerk.mountUserButton(userButtonComponent, {
        afterSignOutUrl: "/",
      });
    } else {
      // add button to mount sign in
      userButtonComponent.innerHTML = `
    <button
      id="sign-in-button"
      class="inline-flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-green-500 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
    >
      Sign in
    </button>
  `;

      const signInButton =
        document.querySelector<HTMLButtonElement>("#sign-in-button")!;

      signInButton.addEventListener("click", () => {
        clerk.openSignIn();
      });
    }
  });
</script>
